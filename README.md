# 针对小样本的椎间盘退变分级系统设计

## 1\. 项目概述

本项目是**一体化椎间盘分析工作流的最终模块**，旨在利用从上游模块筛选出的**稳健影像组学特征**，通过无监督机器学习，建立一个全新的、数据驱动且**具备临床可解释性**的椎间盘退变分级系统。

该系统不依赖于现有的临床分级标准（如Pfirrmann分级），而是首先通过探索数据本身的内在结构发现自然群组，然后**利用临床数据（如疼痛评分）对这些群组进行验证和排序**，从而形成与临床表现高度相关的全新分级标准。

本流程特别针对**小样本量**（几十至一百个病例）进行了优化，采用了稳健的算法以避免过拟合，并强调通过可视化进行结果验证和解读。

-----

## 2\. 步骤与原理

本项目的分析流程主要包括以下四个核心步骤：

### 2.1 步骤一：数据预处理与多视角标准化

*   **目标**：对输入的**稳健特征子集**进行清洗、分组和稳健的标准化，为后续分析做准备，同时尊重不同类型特征的内在数据分布。
*   **算法**：
    1.  **多视角分组 (Multi-View Grouping)**：根据特征名称的前缀（如`shape_`, `firstorder_`, `glcm_`等），自动将特征集分割为“形状”、“一阶强度”和“纹理”等具有不同生物学意义的视角。
    2.  **视角内独立标准化 (Intra-View Scaling)**：**对每个视角内的特征组独立进行标准化**。采用`RobustScaler`，该方法使用对异常值不敏感的中位数和四分位距进行缩放，在小样本数据上比标准差缩放更稳定。这一“分而治之”的策略可以防止某一类特征在数值上主导整个分析过程。
*   **数学原理**：
    对于每个特征 $x$ 的每个观测值 $x_i$，稳健标准化的计算公式为：
    $$x_{scaled, i} = \frac{x_i - Q_2(x)}{Q_3(x) - Q_1(x)}$$
    其中，$Q_1(x)$, $Q_2(x)$ (中位数), 和 $Q_3(x)$ 分别是特征 $x$ 的第一、第二和第三四分位数。

### 2.2 步骤二：降维

*   **目标**：在保留数据主要变异信息的同时，将经过多视角标准化后的高维特征空间压缩到低维空间（2维或3维），以便于可视化和聚类。
*   **算法**：**主成分分析 (Principal Component Analysis, PCA)**。
*   **数学原理**：
    PCA通过线性变换将原始数据投影到一组新的正交坐标轴（主成分）上。第一个主成分（PC1）捕捉了数据中最大的方差方向，第二个主成分捕捉了与第一个正交方向上最大的剩余方差，以此类推。

### 2.3 步骤三：聚类分析与等级定义 (双模态排序)

*   **目标**：在降维后的低维空间中，识别出数据点的自然群组，并为每个群组定义一个有序且具有临床意义的退变等级。
*   **算法与流程**：
    1.  **层次聚类 (Hierarchical Clustering)**：采用**凝聚型层次聚类**算法，自下而上地将最相似的样本（或簇）进行合并。该方法无需预先指定聚类数量，其完整的聚类过程可以通过树状图（Dendrogram）进行可视化。
    2.  **等级排序 (Grade Ranking) - 双模态系统**:
        *   **模式一：临床数据驱动排序 (默认优先)**:
            *   **原理**: 如果输入数据包含临床指标列（如 `Pain_Score`），系统将计算每个聚类的**平均临床评分**，并根据评分高低进行排序。例如，平均疼痛评分最低的簇被定义为等级1，最高的被定义为最高等级。
            *   **统计验证**: 系统会自动运行统计检验（ANOVA或Kruskal-Wallis检验），验证不同影像学分组之间的临床评分是否存在**统计学显著差异**，为新分级的有效性提供证据。
        *   **模式二：PC1驱动排序 (自动回退)**:
            *   **原理**: 如果没有提供临床数据，或用户通过命令行选择不使用，系统将自动回退至纯数据驱动模式。它会根据每个簇的质心在**第一主成分（PC1）**轴上的位置进行排序。由于PC1代表了数据变化最大的方向，沿该轴排序通常能反映出从“健康”到“重度退变”的影像学渐进趋势。

### 2.4 步骤四：确定最佳聚类数 (K)

*   **目标**：为层次聚类确定一个最合理的“切割”数 $K$，即最终分级的等级数量。
*   **方法一：层次聚类与树状图 (主要定性决策依据)**
    *   **原理**: 整个合并过程被可视化为一张**树状图 (Dendrogram)**。研究者可以通过观察树状图的结构，特别是寻找**最长的、未被切割的垂直线**，来直观地判断数据的自然分组数量。
*   **方法二：肘部法 (定量辅助参考)**
    *   **原理**:
        该方法会针对一个范围内的每个 $K$ 值计算其对应的簇内误差平方和（WCSS）。当WCSS的下降速率显著减缓时，形成一个类似“手肘”的拐点。这个“肘点”对应的 $K$ 值，可作为推荐的最佳聚类数。

---

## 3. 输入数据要求

为了实现“零配置”的自动化分析，请将所有输入文件放置在项目根目录下一个名为 `data/raw/` 的文件夹中。程序将根据以下命名和内容规则自动发现并处理它们。

### 3.1 原始特征总表 (必需)

这是主要数据文件，包含了所有样本在筛选前的全部影像组学特征。

*   **作用**: 作为所有影像学特征的数据源。
*   **文件名**: 任意CSV文件名 (例如 `All_Features_2025.csv`)。
    *   **自动识别逻辑**: 程序会将其识别为 `data/raw/` 目录下**文件体积最大**的、且文件名中**不包含** "robust" 或 "clinical" 关键词的CSV文件。
*   **格式**:
    *   标准的CSV文件。
    *   **第一列**: 必须是**样本ID** (例如 `Sample_ID`, `Case_ID`, `id` 等)。程序会自动识别并将其作为合并数据的关键。
    *   **（可选）** 可以包含 `Disc_Level` 列。如果不存在，程序会自动添加一个默认值以确保兼容性。
    *   **其余列**: 包含了所有从“一体化分析系统”中提取的、数值型的影像组学特征。
*   **特征命名规范**: 列名必须遵循“一体化分析系统”的输出规范 (e.g., `original_shape_Sphericity`, `dhi_dhi` 等)，以便程序能正确进行后续的多视角分组标准化。

### 3.2 稳健特征清单 (必需)

这是从“一体化分析系统”的稳健性分析模块导出的“规则”文件，告诉本程序应该使用哪些特征进行分析。

*   **作用**: 作为特征筛选的“规则表”。
*   **文件名**: 文件名中必须包含 **`robust`** 关键词 (例如 `final_robust_features.csv`, `robust_feature_list.csv`)。
*   **格式**:
    *   标准的CSV文件。
    *   必须包含一个名为 **`feature`** 的列，该列中列出了所有通过稳健性测试的特征名称。这些名称必须与“原始特征总表”中的列名完全对应。

### 3.3 临床特征文件 (可选)

如果希望将临床信息融入分级系统，请准备此文件。

*   **作用**: 为分级系统提供临床维度的验证和排序依据。
*   **文件名**: 文件名中必须包含 **`clinical`** 关键词 (例如 `clinical_data.csv`, `patient_clinical_info.csv`)。
*   **格式**:
    *   标准的CSV文件。
    *   **第一列**: **样本ID**。此ID列的名称和内容必须与“原始特征总表”中的ID完全对应，以便程序进行数据对齐（合并）。
    *   **其余列**: 数值型的临床特征（例如 `VAS_Score`, `ODI_Index` 等）。程序会自动识别所有数值列并忽略文本等非数值列。

如果程序在 `data/raw/` 目录下找到此文件，它会自动加载、对齐数据，并将临床特征智能地融入分级流程中。

---

## 4. 如何运行项目

1.  **环境设置**:
    *   确保已安装Anaconda（Python 3.9环境下已验证）。
    *   在项目根目录下，通过命令行安装所有必需的库：
        ```bash
        pip install -r requirements.txt
        ```

2.  **准备数据**:
    *   在项目根目录下创建一个名为 `data` 的文件夹，然后在其中再创建一个名为 `raw` 的文件夹 (最终路径为 `data/raw/`)。
    *   将上述准备好的 **2个必需文件**（原始特征总表、稳健特征清单）和 **1个可选文件**（临床数据）放入 `data/raw/` 文件夹中。

3.  **执行分析**:
    *   打开命令行（或终端），导航到项目根目录。

    *   **标准运行 (推荐)**:
        程序将自动发现文件，并默认使用 **PC1（数据内在结构）** 进行等级排序。
        ```bash
        python main.py
        ```

    *   **使用临床数据运行**:
        如果`data/raw/` 目录中包含了临床数据文件，使用此命令来启用**基于临床指标**的等级排序。
        ```bash
        python main.py --use-clinical
        ```
        *   还可以用 `--clinical-col "Your_Score_Name"` 来精确指定使用哪一列临床指标进行排序（默认是 `VAS_Score`）。

    *   **手动指定文件 (高级/调试模式)**:
        如果自动发现文件失败，或者想使用位于其他位置的文件，可以使用命令行参数手动指定路径：
        ```bash
        python main.py --raw-features "path/to/raw.csv" --robust-list "path/to/robust.csv" --clinical-data "path/to/clinical.csv"
        ```

    *   **交互式提示**:
        程序启动后，会进行一些简单的交互，让用户确认分析选项：
        *   `是否按椎间盘水平分别处理? (y/n):` (仅当数据中包含多个椎间盘节段时出现)
        *   `请选择聚类数量确定方式 (1. 自动 / 2. 手动):`

---

## 5\. 输出结果分析指南

程序运行成功后，会在 `results/` 目录下生成多个核心文件。请按照以下步骤对它们进行分析。

### **步骤一：确定等级数量 (综合决策)**

*   **文件1**: `results/figures/dendrogram.png` (树状图)
    *   **分析 (定性)**: 观察图中**最长的、没有被横线切断的垂直线**，以此作为数据自然分组数量的**主要决策依据**。

*   **文件2**: `results/figures/elbow_plot.png` (肘部图)
    *   **分析 (定量)**: 寻找曲线的“肘点”，作为最佳聚类数的**参考建议**。

### **步骤二：验证分级效果 (看PCA散点图)**

*   **文件**: `results/figures/pca_scatter_plot.png`
*   **分析**:
    *   **看分离度**: 好的结果是，**相同颜色的点（代表同一个新等级）聚集在一起**，不同颜色的点清晰分开。
    *   **看趋势**: 观察不同等级（颜色）是否沿着**横轴PC1**呈现出有序的排列。

### **步骤三：建立新分级标准 (看特征与临床关联)**

*   **文件**: `results/tables/grade_interpretation.csv` 和 **命令行输出**
*   **分析**:
    1.  **查看命令行输出**：在步骤7，程序会直接打印出每个聚类（等级）的平均临床评分和统计检验结果。这是**最直接的证据**，表明影像学分组是否与临床表现显著相关。
    2.  **打开 `grade_interpretation.csv`**: 用Excel打开此文件，它展示了每个新等级在**关键影像组学特征**上的中位数。
    3.  **寻找趋势**: 观察关键特征（如 `shape_Sphericity`）的中位数值，是否随着 `New_Grade` 的递增或递减呈现出单调趋势。
    4.  **撰写标准**: 结合临床和影像学趋势，形成新的分级标准。例如：

| 新等级 | 临床表现 (来自命令行) | 影像组学特征描述 (来自CSV) | 可能的形态学解释 |
| :--- | :--- | :--- | :--- |
| **等级 1** | 平均疼痛评分最低 (e.g., 1.5 ± 0.5) | 球形度最高，信号强度四分位距最大。 | **健康/早期退变**：临床症状轻微，椎间盘形态饱满，含水量充足。 |
| ... | ... | ... | ... |
| **等级 4** | 平均疼痛评分最高 (e.g., 7.8 ± 1.2) | 球形度最低，信号强度四分位距最小。 | **重度退变**：临床症状严重，椎间盘形态严重失常，信号极低。 |

-----

## 6\. 参数设置说明

程序中的关键参数可以在 `config.py` 中进行调整：

*   `PCA_N_COMPONENTS = 2`: PCA降维的目标维数。**建议保持为2或3**。
*   `N_CLUSTERS = 8`: 手动指定聚类数时的默认值。
*   `CLUSTERING_METHOD = 'ward'`: 层次聚类的链接方法。
*   `CLUSTERING_METRIC = 'euclidean'`: 距离度量。
