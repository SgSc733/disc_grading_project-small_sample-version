
# 针对小样本的椎间盘退变分级系统设计

## 1\. 项目概述

本项目旨在利用从椎间盘（IVD）MRI影像中提取到的各种特征，通过无监督机器学习方法，建立一个全新的、数据驱动的椎间盘退变分级系统。该系统不依赖于现有的临床分级标准（如Pfirrmann分级），而是通过探索数据本身的内在结构，发现椎间盘样本在特征空间中的自然群组，并为这些群组赋予可解释的生物学意义，从而形成新的分级标准。

本流程特别针对**小样本量**（几十至一百个病例）进行了优化，采用了稳健的算法以避免过拟合，并强调通过可视化进行结果验证和解读。

-----

## 2\. 步骤与原理

本项目的分析流程主要包括以下四个核心步骤：

### 2.1 步骤一：数据预处理与多视角结构化

  * **目标**：对输入的原始特征数据进行清洗、分组和标准化，为后续分析做准备。
  * **算法**：
    1.  **多视角分组 (Multi-View Grouping)**：根据特征名称的前缀（如`shape_`, `firstorder_`, `glcm_`等），自动将特征集分割为“形状”、“一阶强度”和“纹理”三个具有不同生物学意义的视角。
    2.  **稳健标准化 (Robust Scaling)**：对每个视角内的特征独立进行标准化。采用`RobustScaler`，该方法使用对异常值不敏感的中位数和四分位距进行缩放，在小样本数据上比标准差缩放更稳定。
  * **数学原理**：
    对于每个特征 $x$ 的每个观测值 $x\_i$，稳健标准化的计算公式为：
    $$x_{scaled, i} = \frac{x_i - Q_2(x)}{Q_3(x) - Q_1(x)}$$
    其中，$Q\_1(x)$, $Q\_2(x)$ (中位数), 和 $Q\_3(x)$ 分别是特征 $x$ 的第一、第二和第三四分位数。

### 2.2 步骤二：降维

  * **目标**：在保留数据主要变异信息的同时，将高维特征空间（数百个特征）压缩到低维空间（2维或3维），以便于可视化和聚类。
  * **算法**：**主成分分析 (Principal Component Analysis, PCA)** 。
  * **数学原理**：
    PCA通过线性变换将原始数据投影到一组新的正交坐标轴（主成分）上。第一个主成分捕捉了数据中最大的方差方向，第二个主成分捕捉了与第一个正交方向上最大的剩余方差，以此类推。其目标是找到一个投影矩阵 $W$，使得投影后的数据 $Y = XW$ 的方差最大化。我们选择前 $k$ 个主成分（本项目中 $k=2$）来构成新的低维特征空间。

### 2.3 步骤三：聚类分析与等级定义

  * **目标**：在降维后的2维或3维空间中，识别出数据点的自然群组，并将每个群组定义为一个新的退变等级。
  * **算法**：**K-Means 聚类 (K-Means Clustering)**。
  * **数学原理**：
    K-Means算法的目标是将 $n$ 个样本划分到 $K$ 个簇中，使得每个簇的簇内误差平方和（Within-Cluster Sum of Squares, WCSS，也称为惯性Inertia）最小。其目标函数为：
    $$J = \sum_{j=1}^{K} \sum_{x \in C_j} ||x - \mu_j||^2$$
    其中，$C\_j$ 是第 $j$ 个簇，$x$ 是簇中的样本点，$\\mu\_j$ 是该簇的质心（均值）。

### 2.4 步骤四：确定最佳聚类数 (K)

  * **目标**：为K-Means算法确定一个最合理的聚类数 $K$。本项目采用两种互补的方法：
  * **方法一：层次聚类与树状图 (Qualitative Exploration)**
      * **算法**: **凝聚型层次聚类 (Agglomerative Hierarchical Clustering)**。
      * **原理**: 该方法自下而上地将最相似的样本（或簇）进行合并，直到所有样本都属于同一个簇。整个合并过程可以被可视化为一张**树状图 (Dendrogram)**。研究者可以通过观察树状图的结构，特别是寻找最长的、未被切割的垂直线，来直观地判断数据的自然分组数量。
  * **方法二：肘部法 (Quantitative Suggestion)**
      * **算法**：**肘部法 (Elbow Method)**。
      * **原理**：
        该方法会针对一个范围内的每个 $K$ 值（例如 $K$ 从2到10）运行K-Means算法，并计算其对应的WCSS值（即上述目标函数 $J$ 的值）。然后，将WCSS值随 $K$ 值变化的曲线绘制出来。通常，随着 $K$ 的增加，WCSS会迅速下降，但当 $K$ 超过数据的真实簇数后，下降的速率会显著减缓，形成一个类似“手肘”的拐点。这个“肘点”对应的 $K$ 值，通常被认为是最佳的聚类数。

-----

## 3\. 输入数据要求

  * **文件名**：`features.csv`
  * **位置**：必须放置在 `data/raw/` 目录下。
  * **格式**：标准的CSV文件。
  * **结构**：
      * 第一列必须是样本的唯一标识符，列名为 `Sample_ID`。
      * 其余所有列为影像组学特征，必须为**数值型**。
      * 特征命名必须遵循`PyRadiomics`的标准，即包含类别前缀（如 `shape_Sphericity`, `firstorder_InterquartileRange`），以便程序能正确进行多视角分组。

-----

## 4\. 如何运行项目

1.  **环境设置**：

      * 确保计算机已安装Python环境（推荐使用Anaconda，在python3.9环境下已得到验证）。
      * 在项目根目录下，通过命令行安装所有必需的库：bash
        pip install -r requirements.txt
        ```
        
        ```

2.  **准备数据**：

      * 将准备好的 `features.csv` 文件放入 `data/raw/` 文件夹。

3.  **执行分析**：

      * 打开命令行（或终端），导航到项目根目录。
      * 运行主程序脚本：
        ```bash
        python main.py
        ```
      * 程序运行时，会与进行几次交互：
          * **`是否按椎间盘水平分别处理? (y/n):`**
              * 输入 `y`：程序将只分析特定一个节段的椎间盘（如仅L4-L5）。
              * 输入 `n`：程序将分析文件中所有的椎间盘。
          * **`请输入要处理的椎间盘水平 (例如: L4-L5):`** (仅在上一问选择`y`时出现)
              * 输入想分析的节段名称，例如 `L4-L5`。
          * **`请选择聚类数确定方法 (auto/manual):`**
              * 输入 `auto`：程序将使用肘部法自动寻找最佳聚类数。
              * 输入 `manual`：程序将提示手动输入一个聚类数。

-----

## 5\. 输出结果分析指南

程序运行成功后，会在 `results/` 目录下生成四个核心文件。请按照以下步骤对它们进行分析，以建立新分级系统。

### **步骤一：确定等级数量 (综合决策)**

这是最关键的决策步骤，需要结合两张图的信息进行判断。

  * **文件1**: `results/figures/dendrogram.png` (树状图)

      * **分析 (定性)**:
        1.  打开这张图，它展示了数据的层次结构。
        2.  寻找图中**最长的、没有被横线切断的垂直线**。这些长线代表了数据中天然存在的主要分组之间的巨大差异。
        3.  根据这些长线的位置，在心中形成一个关于“数据最自然地分成了几组”的判断。

  * **文件2**: `results/figures/elbow_plot.png` (肘部图)

      * **分析 (定量)**:
        1.  打开这张图，观察曲线的形状。
        2.  寻找曲线斜率**从陡峭变为平缓**的那个点，这个点就是“肘点”。
        3.  “肘点”对应的聚类数，是算法推荐的最佳分级数。

  * **最终决策**:

      * **如果两者一致**：例如，树状图显示4个清晰的簇，同时肘部图的“肘点”也指向K=4，那么可以基本确定最佳分级数为4。
      * **如果两者不一致**：例如，肘部图的“肘点”不明显，但树状图显示了清晰的结构。在这种情况下，**树状图的结构性证据通常更可靠**。也可以选择手动模式，将分级数设为树状图所指示的数量。

### **步骤二：验证分级效果 (看PCA散点图)**

  * **文件**: `results/figures/pca_scatter_plot.png`
  * **分析**: 
    1.  **看分离度**: 一个好的结果是，**相同颜色的点（代表同一个新等级）聚集在一起，形成相对独立的云团**；而**不同颜色的点在空间上能够清晰地分开**，互相之间的重叠很少。
    2.  **看趋势**: 最理想的情况是，不同的等级（颜色）沿着某个主轴（通常是横轴PC1，因为它代表了数据中最大的差异方向）呈现出**渐进的、有序的排列**。例如，等级1的点在最左边，等级2在中间，等级3在最右边。

### **步骤三：建立新分级标准 (看特征统计表)**

  * **文件**: `results/tables/grade_interpretation.csv`
  * **分析**: 
    1.  用Excel或类似软件打开这个CSV文件。它展示了被划分为每个新等级的所有样本，在**原始影像组学特征**上的中位数。
    2.  **聚焦关键特征**: 首先重点关注那些在之前研究中被证明最重要的特征，例如 **`shape_Sphericity` (二维球形度)** 和 **`firstorder_InterquartileRange` (信号强度四分位距)** 等等。
    3.  **寻找趋势**: 观察这些关键特征的中位数值，是如何随着 `New_Grade` (例如从0到3) 变化的。一个有意义的结果通常会呈现出**单调递增或递减**的趋势。
    4.  **撰写标准**: 将数字化趋势，翻译成描述性的语言，形成新的分级标准。例如可以创建一个如下的表格：

| 新等级 | 影像组学特征描述 | 可能的临床/形态学解释 |
| :--- | :--- | :--- |
| **等级 0** | 球形度最高，信号强度四分位距最大。 | **健康/早期退变**：椎间盘形态饱满、规整。内部信号强度高且均匀，代表含水量充足。 |
| **等级 1** | 球形度中等，信号强度四分位距中等。 | **轻度退变**：椎间盘开始出现轻微的形态改变，信号强度开始下降。 |
| **等级 2** | 球形度较低，信号强度四分位距较低。 | **中度退变**：椎间盘形态改变明显，内部信号显著降低。 |
| **等级 3** | 球形度最低，信号强度四分位距最小。 | **重度退变**：椎间盘形态严重失常，内部信号极低，接近“黑盘”表现。 |

-----

## 6\. 参数设置说明

程序中的关键参数可以在 `config.py` 中进行调整：

  * `PCA_COMPONENTS = 2`: PCA降维的目标维数。**建议保持为2或3**，以确保结果的可视化和可解释性。
  * `CLUSTER_METHOD = 'auto'`: 确定聚类数的方法。可选项为 `'auto'` (使用肘部法) 或 `'manual'` (手动指定)。
  * `MANUAL_CLUSTERS = 4`: 当 `CLUSTER_METHOD` 设置为 `'manual'` 时，程序将使用此数值作为聚类数。

  * `CLUSTER_RANGE = range(2, 11)`: 在使用肘部法时，程序将测试的聚类数范围（从2到10）。
